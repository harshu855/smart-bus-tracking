<!DOCTYPE html>
<html>
<head>
    <title>Smart School Bus Tracking</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        h1 {
            text-align: center;
            background: #004aad;
            color: white;
            padding: 12px;
            margin: 0;
        }
        #map {
            height: calc(100vh - 60px);
            width: 100%;
        }
    </style>
</head>

<body>

<h1>Smart School Bus Live Tracking</h1>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyCesQtDSP9MMYPpb075z7Qjru1Hp5kYxrw",
    authDomain: "smartschoolbus-46e3c.firebaseapp.com",
    databaseURL: "https://smartschoolbus-46e3c-default-rtdb.firebaseio.com",
    projectId: "smartschoolbus-46e3c",
    storageBucket: "smartschoolbus-46e3c.firebasestorage.app",
    messagingSenderId: "800303812272",
    appId: "1:800303812272:web:e74f40e821954c333ab575"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Map
const map = L.map("map").setView([13.0827, 80.2707], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

// Store markers & last positions
const busMarkers = {};
const lastPosition = {};

// Firebase listener
onValue(ref(db, "buses"), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    Object.keys(data).forEach(busId => {
        const { lat, lng, lastUpdated } = data[busId];

        const busNumber = busId.replace("bus", "");

        let status = "Stopped";
        if (lastPosition[busId]) {
            const diff =
                Math.abs(lat - lastPosition[busId].lat) +
                Math.abs(lng - lastPosition[busId].lng);
            if (diff > 0.0001) status = "Moving";
        }

        lastPosition[busId] = { lat, lng };

        const time = new Date(lastUpdated).toLocaleTimeString();

        // NUMBER ICON (NO IMAGE)
        const numberIcon = L.divIcon({
            html: `
                <div style="
                    background:#ff5722;
                    color:white;
                    width:34px;
                    height:34px;
                    border-radius:50%;
                    text-align:center;
                    line-height:34px;
                    font-weight:bold;
                    font-size:16px;
                    border:2px solid white;
                    box-shadow:0 0 6px rgba(0,0,0,0.4);
                ">
                    ${busNumber}
                </div>
            `,
            className: ""
        });

        if (!busMarkers[busId]) {
            busMarkers[busId] = L.marker([lat, lng], { icon: numberIcon }).addTo(map);
        } else {
            busMarkers[busId].setLatLng([lat, lng]);
        }

        busMarkers[busId].bindPopup(
            `<b>Bus ${busNumber}</b><br>
             Status: ${status}<br>
             Last Updated: ${time}`
        );
    });
});
</script>

</body>
</html>
