<!DOCTYPE html>
<html>
<head>
    <title>Smart School Bus Tracking</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        h1 {
            text-align: center;
            background: #004aad;
            color: white;
            padding: 12px;
            margin: 0;
        }
        #map {
            height: calc(100vh - 60px);
            width: 100%;
        }
    </style>
</head>

<body>

<h1>Smart School Bus Live Tracking</h1>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyCesQtDSP9MMYPpb075z7Qjru1Hp5kYxrw",
    authDomain: "smartschoolbus-46e3c.firebaseapp.com",
    databaseURL: "https://smartschoolbus-46e3c-default-rtdb.firebaseio.com",
    projectId: "smartschoolbus-46e3c",
    storageBucket: "smartschoolbus-46e3c.firebasestorage.app",
    messagingSenderId: "800303812272",
    appId: "1:800303812272:web:e74f40e821954c333ab575"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Map
const map = L.map("map").setView([13.0827, 80.2707], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

// Bus icon
const busIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/201/201818.png",
    iconSize: [40, 40]
});

// Bus markers
const busMarkers = {};
const lastPosition = {};

// Firebase listener
onValue(ref(db, "buses"), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    Object.keys(data).forEach(busId => {
        const { lat, lng, lastUpdated } = data[busId];

        let status = "Stopped";
        if (lastPosition[busId]) {
            const diff =
                Math.abs(lat - lastPosition[busId].lat) +
                Math.abs(lng - lastPosition[busId].lng);
            if (diff > 0.0001) status = "Moving";
        }

        lastPosition[busId] = { lat, lng };

        const time = new Date(lastUpdated).toLocaleTimeString();

        if (!busMarkers[busId]) {
            busMarkers[busId] = L.marker([lat, lng], { icon: busIcon }).addTo(map);
        } else {
            busMarkers[busId].setLatLng([lat, lng]);
        }

        busMarkers[busId].bindPopup(
            `<b>${busId.toUpperCase()}</b><br>
             Status: ${status}<br>
             Last Updated: ${time}`
        );
    });
});

// Bus Stops
const busStops = [
    { name: "Stop 1", lat: 13.0850, lng: 80.2750 },
    { name: "Stop 2", lat: 13.0900, lng: 80.2800 },
    { name: "Stop 3", lat: 13.0950, lng: 80.2850 }
];

busStops.forEach(stop => {
    L.marker([stop.lat, stop.lng])
        .addTo(map)
        .bindPopup(stop.name);
});

</script>

</body>
</html>
